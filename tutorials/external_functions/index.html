<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Tutorial on how to integrate external functions with XAD, e.g. functions defined in third party libraries.
"><meta name=author content=Xcelerit><link href=https://auto-differentiation.github.io/tutorials/external_functions/ rel=canonical><link href=../basic/ rel=prev><link href=../checkpointing/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.13"><title>External Functions - XAD</title><link rel=stylesheet href=../../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../custom.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-FKBZYBC759"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-FKBZYBC759",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-FKBZYBC759",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script><meta property=og:type content=website><meta property=og:title content="External Functions - XAD"><meta property=og:description content="Tutorial on how to integrate external functions with XAD, e.g. functions defined in third party libraries.
"><meta property=og:image content=https://auto-differentiation.github.io/assets/images/social/tutorials/external_functions.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://auto-differentiation.github.io/tutorials/external_functions/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="External Functions - XAD"><meta name=twitter:description content="Tutorial on how to integrate external functions with XAD, e.g. functions defined in third party libraries.
"><meta name=twitter:image content=https://auto-differentiation.github.io/assets/images/social/tutorials/external_functions.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/site.webmanifest><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><link rel="shortcut icon" href=/favicon/favicon.ico><meta name=msapplication-TileColor content=#ffc40d><meta name=msapplication-config content=/favicon/browserconfig.xml></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=grey data-md-color-accent=amber> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#external-functions class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=XAD class="md-header__button md-logo" aria-label=XAD data-md-component=logo> <img src=../../images/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> XAD </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> External Functions </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=grey data-md-color-accent=amber aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/auto-differentiation/XAD/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> XAD </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../installation/ class=md-tabs__link> Installation </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../aad/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../examples/simple_examples/ class=md-tabs__link> Examples </a> </li> <li class=md-tabs__item> <a href=../../ref/headers/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../about/ class=md-tabs__link> About </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=XAD class="md-nav__button md-logo" aria-label=XAD data-md-component=logo> <img src=../../images/logo.svg alt=logo> </a> XAD </label> <div class=md-nav__source> <a href=https://github.com/auto-differentiation/XAD/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> XAD </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../aad/ class=md-nav__link> <span class=md-ellipsis> AD Background </span> </a> </li> <li class=md-nav__item> <a href=../basic/ class=md-nav__link> <span class=md-ellipsis> Basic Usage </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> External Functions </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> External Functions </span> </a> <nav class="md-nav md-nav--secondary" aria-label=Contents> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#example-algorithm class=md-nav__link> <span class=md-ellipsis> Example Algorithm </span> </a> </li> <li class=md-nav__item> <a href=#external-function-for-adjoint-mode class=md-nav__link> <span class=md-ellipsis> External Function For Adjoint Mode </span> </a> <nav class=md-nav aria-label="External Function For Adjoint Mode"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#computeexternal-method class=md-nav__link> <span class=md-ellipsis> computeExternal Method </span> </a> </li> <li class=md-nav__item> <a href=#computeadjoint-method class=md-nav__link> <span class=md-ellipsis> computeAdjoint Method </span> </a> </li> <li class=md-nav__item> <a href=#wrapper-function class=md-nav__link> <span class=md-ellipsis> Wrapper Function </span> </a> </li> <li class=md-nav__item> <a href=#call-site class=md-nav__link> <span class=md-ellipsis> Call-Site </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#external-function-for-forward-mode class=md-nav__link> <span class=md-ellipsis> External Function For Forward Mode </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../checkpointing/ class=md-nav__link> <span class=md-ellipsis> Checkpointing </span> </a> </li> <li class=md-nav__item> <a href=../higher_order/ class=md-nav__link> <span class=md-ellipsis> Higher-Order Derivatives </span> </a> </li> <li class=md-nav__item> <a href=../smoothed_math/ class=md-nav__link> <span class=md-ellipsis> Handling Discontinuities </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../examples/simple_examples/ class=md-nav__link> <span class=md-ellipsis> Simple Examples </span> </a> </li> <li class=md-nav__item> <a href=../../examples/quantlib/ class=md-nav__link> <span class=md-ellipsis> Large Codebase Integration </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ref/headers/ class=md-nav__link> <span class=md-ellipsis> Headers and Namespaces </span> </a> </li> <li class=md-nav__item> <a href=../../ref/interface/ class=md-nav__link> <span class=md-ellipsis> AD Mode Interface </span> </a> </li> <li class=md-nav__item> <a href=../../ref/freal/ class=md-nav__link> <span class=md-ellipsis> Forward Mode Type FReal </span> </a> </li> <li class=md-nav__item> <a href=../../ref/areal/ class=md-nav__link> <span class=md-ellipsis> Adjoint Mode Type AReal </span> </a> </li> <li class=md-nav__item> <a href=../../ref/global/ class=md-nav__link> <span class=md-ellipsis> Global Functions </span> </a> </li> <li class=md-nav__item> <a href=../../ref/math/ class=md-nav__link> <span class=md-ellipsis> Mathematical Operations </span> </a> </li> <li class=md-nav__item> <a href=../../ref/complex/ class=md-nav__link> <span class=md-ellipsis> Complex </span> </a> </li> <li class=md-nav__item> <a href=../../ref/smooth-math/ class=md-nav__link> <span class=md-ellipsis> Smoothed Mathematical Functions </span> </a> </li> <li class=md-nav__item> <a href=../../ref/expressions/ class=md-nav__link> <span class=md-ellipsis> Expressions </span> </a> </li> <li class=md-nav__item> <a href=../../ref/tape/ class=md-nav__link> <span class=md-ellipsis> Tape </span> </a> </li> <li class=md-nav__item> <a href=../../ref/chkpt_cb/ class=md-nav__link> <span class=md-ellipsis> CheckpointCallback </span> </a> </li> <li class=md-nav__item> <a href=../../ref/exceptions/ class=md-nav__link> <span class=md-ellipsis> Exceptions </span> </a> </li> <li class=md-nav__item> <a href=../../ref/version/ class=md-nav__link> <span class=md-ellipsis> Version Information </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=Contents> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#example-algorithm class=md-nav__link> <span class=md-ellipsis> Example Algorithm </span> </a> </li> <li class=md-nav__item> <a href=#external-function-for-adjoint-mode class=md-nav__link> <span class=md-ellipsis> External Function For Adjoint Mode </span> </a> <nav class=md-nav aria-label="External Function For Adjoint Mode"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#computeexternal-method class=md-nav__link> <span class=md-ellipsis> computeExternal Method </span> </a> </li> <li class=md-nav__item> <a href=#computeadjoint-method class=md-nav__link> <span class=md-ellipsis> computeAdjoint Method </span> </a> </li> <li class=md-nav__item> <a href=#wrapper-function class=md-nav__link> <span class=md-ellipsis> Wrapper Function </span> </a> </li> <li class=md-nav__item> <a href=#call-site class=md-nav__link> <span class=md-ellipsis> Call-Site </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#external-function-for-forward-mode class=md-nav__link> <span class=md-ellipsis> External Function For Forward Mode </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=external-functions>External Functions<a class=headerlink href=#external-functions title="Permanent link">&para;</a></h1> <p>Often parts of the algorithm to be differentiated are not available in source code. For example, a routine from an external math library may be called. Reimplementing it may not be desirable (for performance or development effort reasons), in which case the derivatives of this function need to be implemented manually in some form.</p> <p>This can be achieved by either:</p> <ul> <li>Applying finite differences to the library function (bumping),</li> <li>Implementing the adjoint code of the function by hand, or</li> <li>Computing the derivatives analytically, possibly using other library functions.</li> </ul> <p>In these cases, the <em>external function interface</em> of XAD can be used to integrate the manual derivatives, which is described below. With the same technique, performance- or memory-critical parts of the application may be hand-tuned.</p> <h2 id=example-algorithm>Example Algorithm<a class=headerlink href=#example-algorithm title="Permanent link">&para;</a></h2> <p>We pick an example algorithm which computes the length of a multi dimensional vector. This is defined as:</p> <div class=arithmatex>\[ y = \sqrt{\sum_0^{N-1} x_i^2} \]</div> <p>The goal is to compute the derivatives of <span class=arithmatex>\(y\)</span> with respect to all input vector elements using adjoint mode.</p> <p>The algorithm can be implemented in C++ code as:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=w> </span><span class=n>xsqr</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=n>xsqr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kt>double</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_elements</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>));</span>
</code></pre></div> <p>For this example, we assume that the <code>sum_elements</code> is an external function implemented in a library that we do not have source code of. It has the prototype:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kt>double</span><span class=w> </span><span class=nf>sum_elements</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>double</span><span class=o>*</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</code></pre></div> <h2 id=external-function-for-adjoint-mode>External Function For Adjoint Mode<a class=headerlink href=#external-function-for-adjoint-mode title="Permanent link">&para;</a></h2> <p>To use the external function, we follow this procedure:</p> <ol> <li>At the point of the call, convert the values of the input active variables to the underlying plain data type (<code class=highlight><span class=kt>double</span></code>)</li> <li>Call the external function passively</li> <li>Assign the result values to active output variables so the tape recording can continue</li> <li>Store the tape slots of the inputs and outputs with a checkpoint callback object and register it with the tape.</li> <li>When computing adjoints, this callback needs to load the adjoint of the outputs, propagate to them to the inputs manually, and increment the input adjoints by these values.</li> </ol> <p>We put all the functionality into a callback object. We derive from the <a href=../../ref/chkpt_cb/#checkpointcallback><code>CheckpointCallback</code></a> base class and implement at least the virtual method <a href=../../ref/chkpt_cb/#computeadjoint><code>CheckpointCallback::computeAdjoint</code></a>. This method gets called during tape rollback. We also place the forward computation within the same object (this could also be done outside of the callback class). The declaration of our callback class looks like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>Tape</span><span class=o>&gt;</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>class</span><span class=w> </span><span class=nc>ExternalSumElementsCallback</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>xad</span><span class=o>::</span><span class=n>CheckpointCallback</span><span class=o>&lt;</span><span class=n>Tape</span><span class=o>&gt;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=p>{</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=k>typedef</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>Tape</span><span class=o>::</span><span class=n>slot_type</span><span class=w>   </span><span class=n>slot_type</span><span class=p>;</span><span class=w>   </span><span class=c1>// type for slot in the tape</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=k>typedef</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>Tape</span><span class=o>::</span><span class=n>value_type</span><span class=w>  </span><span class=n>value_type</span><span class=p>;</span><span class=w>  </span><span class=c1>// double</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=k>typedef</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>Tape</span><span class=o>::</span><span class=n>active_type</span><span class=w> </span><span class=n>active_type</span><span class=p>;</span><span class=w> </span><span class=c1>// AReal&lt;double&gt;</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=n>active_type</span><span class=w> </span><span class=nf>computeExternal</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>active_type</span><span class=o>*</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>);</span><span class=w> </span><span class=c1>// forward compute</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>computeAdjoint</span><span class=p>(</span><span class=n>Tape</span><span class=o>*</span><span class=w> </span><span class=n>tape</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=p>;</span><span class=w>                 </span><span class=c1>// adjoint compute</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>slot_type</span><span class=o>&gt;</span><span class=w> </span><span class=n>inputSlots_</span><span class=p>;</span><span class=w>             </span><span class=c1>// slots of inputs in tape</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>    </span><span class=n>slot_type</span><span class=w> </span><span class=n>outputSlot_</span><span class=p>;</span><span class=w>                          </span><span class=c1>// slot of output in tape</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>   </span><span class=p>};</span>
</code></pre></div> <p>We declare it as a template for arbitrary tape types, which is good practice as it allows to reuse this implementation with higher order derivatives too.</p> <h3 id=computeexternal-method><code>computeExternal</code> Method<a class=headerlink href=#computeexternal-method title="Permanent link">&para;</a></h3> <p>Within the <code>computeExternal</code> method, we first store the slots in the tape for the input variables, as we will need them during adjoint computation to increment the corresponding adjoints. We use the <code>inputSlots_</code> member vector to keep this information:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=n>inputSlots_</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>getSlot</span><span class=p>());</span>
</code></pre></div> <p>Then we create a copy of the active inputs and store them in a vector of passive values, with which we can call the external function:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>value_type</span><span class=o>&gt;</span><span class=w> </span><span class=n>x_p</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=n>x_p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=n>value_type</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sum_elements</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x_p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</code></pre></div> <p>We now need to store this result in an active variable, register it as an output of the external function (to allow the tape to continue recording dependent variables), and keep its slot in the tape for the later adjoint computation:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>active_type</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=n>Tape</span><span class=o>::</span><span class=n>getActive</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>registerOutput</span><span class=p>(</span><span class=n>ret</span><span class=p>);</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=n>outputSlot_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ret</span><span class=p>.</span><span class=n>getSlot</span><span class=p>();</span>
</code></pre></div> <p>Finally we need to insert the callback into the tape, hence requesting it to be called during adjoint rollback of the tape, and return:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>Tape</span><span class=o>::</span><span class=n>getActive</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>insertCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span>
</code></pre></div> <h3 id=computeadjoint-method><code>computeAdjoint</code> Method<a class=headerlink href=#computeadjoint-method title="Permanent link">&para;</a></h3> <p>The <code>computeAdjoint</code> method gets called by XAD during tape rollback. We need to override this method and implement the manual adjoint code. For a simple sum operation, this is straightforward: all input adjoints are equal to the output adjoint since all partial derivatives are 1. Thus we need to obtain the output adjoint and increment all input adjoints by this value:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>value_type</span><span class=w> </span><span class=n>output_adj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tape</span><span class=o>-&gt;</span><span class=n>getAndResetOutputAdjoint</span><span class=p>(</span><span class=n>outputSlot_</span><span class=p>);</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>inputSlots_</span><span class=p>.</span><span class=n>size</span><span class=p>();</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=n>tape</span><span class=o>-&gt;</span><span class=n>incrementAdjoint</span><span class=p>(</span><span class=n>inputSlots_</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=w> </span><span class=n>output_adj</span><span class=p>);</span><span class=w> </span>
</code></pre></div> <p>The function <a href=../../ref/tape/#getandresetoutputadjoint><code>Tape::getAndResetOutputAdjoint</code></a> obtains the adjoint value corresponding to the given slot and resets it to zero. This reset is necessary in general as the output variable may have been overwriting other values in the forward computation. The <a href=../../ref/tape/#incrementadjoint><code>Tape::incrementAdjoint</code></a> function simply increments the adjoint with the given slot by the given value.</p> <h3 id=wrapper-function>Wrapper Function<a class=headerlink href=#wrapper-function title="Permanent link">&para;</a></h3> <p>With the checkpointing callback class in place, we can implement a <code>sum_elements</code> overload for <a href=../../ref/areal/ ><code>AReal</code></a> that wraps the creation of this callback::</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=n>xad</span><span class=o>::</span><span class=n>AReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>sum_elements</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>xad</span><span class=o>::</span><span class=n>AReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;*</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=p>{</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>    </span><span class=k>typedef</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>xad</span><span class=o>::</span><span class=n>AReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;::</span><span class=n>tape_type</span><span class=w> </span><span class=n>tape_type</span><span class=p>;</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>    </span><span class=n>tape_type</span><span class=o>*</span><span class=w> </span><span class=n>tape</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tape_type</span><span class=o>::</span><span class=n>getActive</span><span class=p>();</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>    </span><span class=n>ExternalSumElementsCallback</span><span class=o>&lt;</span><span class=n>tape_type</span><span class=o>&gt;*</span><span class=w> </span><span class=n>ckp</span><span class=w> </span><span class=o>=</span><span class=w> </span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>ExternalSumElementsCallback</span><span class=o>&lt;</span><span class=n>tape_type</span><span class=o>&gt;</span><span class=p>;</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>    </span><span class=n>tape</span><span class=o>-&gt;</span><span class=n>pushCallback</span><span class=p>(</span><span class=n>ckp</span><span class=p>);</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ckp</span><span class=o>-&gt;</span><span class=n>computeExternal</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=p>}</span>
</code></pre></div> <p>This function dynamically allocates the checkpoint callback object and lets the tape manage its destruction via the <a href=../../ref/tape/#pushcallback><code>Tape::pushCallback</code></a> function. This call simply ensures that the callback object is destroyed when the tape is destroyed, making sure that no memory is leaked. If the callback object was managed elsewhere, this call would not be necessary. It then redirects the computation to the <code>computeExternal</code> function of the checkpoint callback class. Using this wrapper class, the <code>sum_elements</code> function can be used for active types in the same fashion as the original external function <code>sum_elements</code> for <code class=highlight><span class=kt>double</span></code>. Defining it as a template allows us to re-use this function for higher-order derivatives, should we need them in future.</p> <h3 id=call-site>Call-Site<a class=headerlink href=#call-site title="Permanent link">&para;</a></h3> <p>The call site then can be implemented as (assuming that <code>x_ad</code> is the vector holding the independent variables, already registered on tape):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>tape</span><span class=p>.</span><span class=n>newRecording</span><span class=p>();</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>AD</span><span class=o>&gt;</span><span class=w> </span><span class=n>xsqr</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>    </span><span class=n>xsqr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x_ad</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>x_ad</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=n>AD</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_elements</span><span class=p>(</span><span class=n>xsqr</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span><span class=w> </span><span class=n>n</span><span class=p>));</span><span class=w> </span><span class=c1>// calls external function wrapper</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=n>tape</span><span class=p>.</span><span class=n>registerOutput</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=n>derivative</span><span class=p>(</span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1.0</span><span class=p>;</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=n>tape</span><span class=p>.</span><span class=n>computeAdjoints</span><span class=p>();</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;y = &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>value</span><span class=p>(</span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;dy/dx&quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; = &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>derivative</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
</code></pre></div> <p>This follows exactly the same procedure as given in <a href=../basic/#adjoint-mode>Basic Usage</a>.</p> <div class="admonition note"> <p class=admonition-title>See also</p> <p>This example is included with XAD (<a href=https://github.com/auto-differentiation/XAD/tree/main/samples/external_function><code>external_function</code></a>).</p> </div> <h2 id=external-function-for-forward-mode>External Function For Forward Mode<a class=headerlink href=#external-function-for-forward-mode title="Permanent link">&para;</a></h2> <p>Since forward mode involves no tape, a manual implementation of the derivative computation needs to be implemented together with computing the value. The manual derivatives can be updated directly in the output values using the <a href=../../ref/global/#derivative><code>derivative</code></a> function.</p> <p>In our example, we can implement the external function in forward mode as:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=w> </span><span class=nc>T</span><span class=o>&gt;</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=n>xad</span><span class=o>::</span><span class=n>FReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>sum_elements</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>xad</span><span class=o>::</span><span class=n>FReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;*</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=p>{</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=k>typedef</span><span class=w> </span><span class=n>xad</span><span class=o>::</span><span class=n>FReal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>active_type</span><span class=p>;</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>x_p</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span><span class=n>x_p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=n>T</span><span class=w> </span><span class=n>y_p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sum_elements</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x_p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>    </span><span class=n>active_type</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y_p</span><span class=p>;</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>    </span><span class=n>derivative</span><span class=p>(</span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>derivative</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=p>}</span>
</code></pre></div> <p>We first extract the passive values from the <code>x</code> vector and call the external library function to get the passive output value <code>y_p</code>. This value is then assigned to the active output variable <code>y</code>, which also initializes its derivative to <code>0</code>.</p> <p>As we have a simple sum in this example, the derivative of the output is a sum of the derivatives of the inputs, which is computed by the loop in the end.</p> <div class="admonition note"> <p class=admonition-title>See also</p> <p>This example is included with XAD (<a href=https://github.com/auto-differentiation/XAD/tree/main/samples/external_function><code>external_function</code></a>).</p> </div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../basic/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Basic Usage"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Basic Usage </div> </div> </a> <a href=../checkpointing/ class="md-footer__link md-footer__link--next" aria-label="Next: Checkpointing"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Checkpointing </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2010-2024, Xcelerit Computing Ltd | <a href=#__consent>Cookie settings</a> </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../..", "features": ["toc.follow", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.footer", "navigation.indexes", "navigation.sections", "search.highlight", "search.share", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "v1.4.1"}</script> <script src=../../assets/javascripts/bundle.c8d2eff1.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js></script> </body> </html>